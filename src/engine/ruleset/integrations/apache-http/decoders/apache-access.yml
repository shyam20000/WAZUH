name: decoder/apache-access/0

metadata:
  module: apache-http
  title: Apache HTTP Server access logs decoder
  description: Decoder for Apache HTTP Server access logs.
  compatibility: The Apache datasets were tested with Apache 2.4.12 and 2.4.46 and are expected to work with all versions >= 2.2.31 and >= 2.4.16 (independent from operating system).
  versions:
    - "2.2.31"
    - "2.4.16"
  author:
    name: Wazuh Inc.
    email: info@wazuh.com
    date: 2022-11-15
  references:
    - https://httpd.apache.org/docs/2.4/logs.html

check:
  - event.original: regex_match(\\S+\\s-\\s\\S+\\s\\[)
#TODO: Once the events arrive tagged, uncomment these lines below and remove the above `event.original`
# - event.module: apache-http
# - event.dataset: apache-access

definitions:
  isSuccess: is_not_null($http.response.status_code) AND int_less($http.response.status_code,400)
  isFailed: is_not_null($http.response.status_code) AND int_greater_or_equal($http.response.status_code,400)

parse:
  logpar:
    - event.original: <source.address> - <user.name> [<event.created/26\/Dec\/2016:18:23:35 +0200>] "<_http_request/text>" <http.response.status_code> <_ignore/literal/->?<http.response.body.bytes>(? "<http.request.referrer>" "<user_agent.original>")
    - event.original: <source.address> - <user.name> [<event.created/26\/Dec\/2016:18:23:35 +0200>] "-" <http.response.status_code> -
    - event.original: <source.address> - - [<event.created/%a %b %d %T %Y/en_US.UTF-8>] "-" <http.response.status_code> -
    - event.original: <destination.domain> <source.address> - <user.name> [<event.created/%a %b %d %T %Y/en_US.UTF-8>] "<http.request.method> <_url_orig> <http.version>?<_dash>" <http.response.status_code> <http.response.body.bytes>?<_dash> "<http.request.referrer>" "<user_agent.original>"
    - event.original: <source.address> - - [<event.created/%a %b %d %T %Y/en_US.UTF-8>] "<http.request.method> <_url_orig> <http.version>?<_dash>" <http.response.status_code> <http.response.body.bytes>?<_dash> "<http.request.referrer>" "<user_agent.original>"
    - event.original: <source.address> - <user.name> [<event.created/%a %b %d %T %Y/en_US.UTF-8>] "<http.request.method> <_url_orig> <http.version>?<_dash>" <http.response.status_code> <http.response.body.bytes>?<_dash> "<http.request.referrer>" "<user_agent.original>"
    - event.original: '[<event.created/%a %b %d %T %Y/en_US.UTF-8>] <source.address> <network.protocol> <tls.cipher> "<http.request.method> <_url_orig> <http.version>" <http.response.body.bytes>?<_dash>'

normalize:
  - map:
      - event.category: array_append(web)
      - event.dataset: apache-access
      - event.kind: event
      - event.module: apache-http
      - service.type: apache
      - wazuh.decoders: array_append(apache-access)

      - source.ip: parse_ip($source.address)
      - _tls: split($network.protocol, v)
      - _tls-1: $_tls/1
      - tls.version_protocol: $_tls/0
      - tls.cipher: $tls.cipher

    logpar:
      - _http_request: <http.request.method> <url.original> HTTP/<http.version>

  - check:
      - _tls-1: regex_match(\\d+\\.\\d+)
    map:
      - tls.version: $_tls-1

  - check:
      - _tls-1: regex_not_match(\\d+\\.\\d+)
    map:
      - tls.version: concat($_tls-1, .0)

  - check: $isSuccess
    map:
      - event.outcome: success
  - check: $isFailed
    map:
      - event.outcome: failure

  - check:
      - source.ip: not_exists()
    map:
      - source.domain: parse_fqdn($source.address)

  - map:
      - url.extension: regex_extract($url.original, .*\\.([^.]+\)$)
