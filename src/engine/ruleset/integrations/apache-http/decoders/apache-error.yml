name: decoder/apache-error/0

metadata:
  module: apache-http
  title: Apache HTTP Server error logs decoder
  description: Decoder for Apache HTTP Server error logs.
  compatibility: The Apache datasets were tested with Apache 2.4.12 and 2.4.46 and are expected to work with all versions >= 2.2.31 and >= 2.4.16 (independent from operating system).
  versions:
    - "2.4.12"
    - "2.4.46"
  author:
    name: Wazuh Inc.
    email: info@wazuh.com
    date: 2022-11-15
  references:
    - https://httpd.apache.org/docs/2.4/logs.html
    - https://httpd.apache.org/docs/2.4/custom-error.html

check:
  - event.original: starts_with([)
#TODO: Once the events arrive tagged, uncomment these lines below and remove the above regex
# - event.module: apache-http
# - event.dataset: apache-error

parse:
  logpar:
    # [Wed Oct 20 19:20:59.121211 2021] [rewrite:trace3] [pid 121591:tid 140413273032448] mod_rewrite.c(470): [client 10.121.192.8:38350] 10.121.192.8 - - [dev.elastic.co/sid#55a374e851c8][rid#7fb438083ac0/initial] applying pattern '^/import/?(.*)$' to uri '/'
    # [Wed Oct 20 19:20:59.121211 2021] [rewrite:trace3] [pid 121591:tid 140413273032448] mod_rewrite.c(470): [client milo.dom.com:513] 10.121.192.8 - - [dev.elastic.co/sid#55a374e851c8][rid#7fb438083ac0/initial] applying pattern '^/import/?(.*)$' to uri '/'
    # [Fri Sep 09 10:42:29.902022 2011] [core:error] [pid 35708:tid 4328636416] [client 89.160.20.112] File does not exist: /usr/local/apache2/htdocs/favicon.ico
    # [Thu Jun 27 06:58:09.169510 2019] [include:warn] [pid 15934] [client 67.43.156.12:12345] AH01374: mod_include: Options +Includes (or IncludesNoExec) wasn't set, INCLUDES filter removed: /test.html
    - event.original: "[<event.created/%a %b %d %T %Y/en_US.UTF-8>] [<log.logger>:<log.level>] [pid <process.pid>(?:tid <process.thread.id>)] [client <source.address>(?:<source.port>)] <message>"
    # [Mon Dec 26 16:15:55.103786 2016] [core:notice] [pid 11379] AH00094: Command line: '/usr/local/Cellar/httpd24/2.4.23_2/bin/httpd'
    # [Mon Dec 26 16:15:55.103522 2016] [mpm_prefork:notice] [pid 11379] AH00163: Apache/2.4.23 (Unix) configured -- resuming normal operations
    - event.original: "[<event.created/%a %b %d %T %Y/en_US.UTF-8>] [<log.logger>:<log.level>] [pid <process.pid>(?:tid <process.thread.id>)] <message>"
    # [Mon Dec 26 16:22:00 2016] [error] [client 192.168.33.1] File does not exist: /var/www/favicon.ico, referer: http://192.168.33.72/
    # [Mon Dec 26 16:22:00 2016] [error] [client 2001:981:26e2:1:f8f9:ef76:50af:be81] File does not exist: /var/www/favicon.ico, referer: http://192.168.33.72/
    # [Mon Dec 26 16:22:08 2016] [error] [client 192.168.33.1] File does not exist: /var/www/favicon.ico
    - event.original: "[<event.created/Mon Dec 26 16:22:00 2016>] [<log.level>] [client <source.address>(?:<source.port>)] <message>"
    # [Mon Dec 26 16:17:53 2016] [notice] Apache/2.2.22 (Ubuntu) configured -- resuming normal operations
    - event.original: "[<event.created/Mon Dec 26 16:22:00 2016>] [<log.level>] <message>"

normalize:
  - map:
      - event.category: array_append(web)
      - event.dataset: apache-error
      - event.kind: event
      - event.module: apache-http
      - service.type: apache
      - wazuh.decoders: array_append(apache-error)

      - source.ip: parse_ip($source.address)

  - check:
      - log.level: regex_match(^(?:emerg|alert|crit|error|warn\)$)
    map:
      - event.type: array_append(error)
  - check:
      - log.level: regex_not_match(^(?:emerg|alert|crit|error|warn\)?$)
    map:
      - event.type: array_append(info)

  - logpar:
      - message: "File does not exist: <file.path>(?, referer: <http.request.referrer>)"

  - check:
      - source.ip: not_exists()
    map:
      - source.domain: parse_fqdn($source.address)
